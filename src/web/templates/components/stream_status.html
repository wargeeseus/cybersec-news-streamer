<div class="stream-panel">
    <h3>Stream Control</h3>

    <div class="stream-info">
        <div>
            <strong>Status:</strong>
            <span class="status-badge {{ 'approved' if stream_status.is_running else 'pending' }}">
                {{ stream_status.state }}
            </span>
        </div>
    </div>

    {% if stream_status.current_item_id or stream_status.current_item_title %}
    <div style="margin-top: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">NOW SHOWING</div>
        <div style="font-size: 13px; color: var(--accent-green);">
            {{ stream_status.current_item_title or 'Item #' + stream_status.current_item_id|string }}
        </div>
    </div>
    {% endif %}

    <div style="margin-top: 15px; display: flex; gap: 10px;">
        {% if stream_status.is_running %}
        <button class="btn btn-stream stop"
                hx-post="/api/stream/stop"
                hx-target="#stream-status"
                hx-swap="innerHTML">
            Stop Stream
        </button>
        {% else %}
        <button class="btn btn-stream"
                hx-post="/api/stream/start"
                hx-target="#stream-status"
                hx-swap="innerHTML"
                {% if not config or not config.youtube_stream_key %}disabled title="Configure stream key first"{% endif %}>
            Start Stream
        </button>
        {% endif %}
        <button class="btn btn-edit" onclick="togglePreview()">
            Preview
        </button>
    </div>

    <!-- Stream Preview -->
    <div id="stream-preview" style="display: none; margin-top: 15px;">
        <div style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: #000;">
            <!-- Frame Preview -->
            <div id="frame-preview-container">
                <img id="frame-preview-img"
                     src="/api/stream/current-frame?t={{ range(1000000) | random }}"
                     style="width: 100%; height: auto; display: block;"
                     alt="Current Frame"
                     onerror="this.style.display='none'; document.getElementById('no-frame-msg').style.display='block';">
                <div id="no-frame-msg" style="display: none; padding: 40px; text-align: center; color: var(--text-secondary);">
                    <div style="font-size: 18px; margin-bottom: 10px;">No frames available</div>
                    <div style="font-size: 12px;">Approve some news items first</div>
                </div>
            </div>

            <!-- YouTube Embed (if configured) -->
            {% if config and config.youtube_video_id %}
            <div style="margin-top: 10px;">
                <div style="font-size: 11px; color: var(--text-secondary); padding: 5px 10px;">YOUTUBE LIVE</div>
                <iframe
                    width="100%"
                    height="200"
                    src="https://www.youtube.com/embed/{{ config.youtube_video_id }}?autoplay=1&mute=1"
                    frameborder="0"
                    allow="autoplay; encrypted-media"
                    allowfullscreen>
                </iframe>
            </div>
            {% endif %}
        </div>

        <!-- YouTube Video ID Config -->
        <div style="margin-top: 10px;">
            <form hx-post="/api/config/youtube-embed"
                  hx-target="#stream-status"
                  hx-swap="innerHTML"
                  style="display: flex; gap: 8px; align-items: center;">
                <input type="text"
                       name="youtube_video_id"
                       value="{{ config.youtube_video_id if config and config.youtube_video_id else '' }}"
                       placeholder="YouTube Video ID (e.g., dQw4w9WgXcQ)"
                       style="flex: 1; padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                <button type="submit" class="btn btn-edit" style="padding: 6px 12px; font-size: 12px;">
                    Embed
                </button>
            </form>
            <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
                Find Video ID in YouTube Studio → Go Live → copy from stream URL
            </div>
        </div>
    </div>

    <!-- Stream Configuration -->
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
        <h4 style="margin-bottom: 15px; font-size: 14px; display: flex; justify-content: space-between; align-items: center;">
            Stream Configuration
            <button type="button" class="btn btn-edit" style="padding: 4px 8px; font-size: 12px;"
                    onclick="toggleConfig()">
                Edit
            </button>
        </h4>

        <!-- Config Display -->
        <div id="config-display">
            <div style="font-size: 13px; color: var(--text-secondary);">
                <div style="margin-bottom: 8px;">
                    <span>Stream Key:</span>
                    <span style="color: {{ 'var(--accent-green)' if config and config.youtube_stream_key else 'var(--accent-red)' }};">
                        {% if config and config.youtube_stream_key %}
                            ********{{ config.youtube_stream_key[-4:] }}
                        {% else %}
                            Not configured
                        {% endif %}
                    </span>
                </div>
                <div style="margin-bottom: 8px;">
                    <span>Display Time:</span>
                    <span>{{ config.news_display_seconds if config else 30 }}s per item</span>
                </div>
                <div>
                    <span>RTMP URL:</span>
                    <span style="font-size: 11px;">{{ config.rtmp_url if config else 'rtmp://a.rtmp.youtube.com/live2' }}</span>
                </div>
            </div>
        </div>

        <!-- Config Form (hidden by default) -->
        <form id="config-form" style="display: none;"
              hx-post="/api/config/stream"
              hx-target="#stream-status"
              hx-swap="innerHTML"
              hx-on::after-request="window.isEditingConfig = false">
            <div class="form-group" style="margin-bottom: 12px;">
                <label for="youtube_stream_key" style="font-size: 12px; color: var(--text-secondary);">
                    YouTube Stream Key
                </label>
                <input type="password"
                       id="youtube_stream_key"
                       name="youtube_stream_key"
                       value="{{ config.youtube_stream_key if config else '' }}"
                       placeholder="xxxx-xxxx-xxxx-xxxx"
                       style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
                <label for="news_display_seconds" style="font-size: 12px; color: var(--text-secondary);">
                    Display Duration (seconds)
                </label>
                <input type="number"
                       id="news_display_seconds"
                       name="news_display_seconds"
                       value="{{ config.news_display_seconds if config else 30 }}"
                       min="5"
                       max="300"
                       style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
                <label for="rtmp_url" style="font-size: 12px; color: var(--text-secondary);">
                    RTMP URL
                </label>
                <input type="text"
                       id="rtmp_url"
                       name="rtmp_url"
                       value="{{ config.rtmp_url if config else 'rtmp://a.rtmp.youtube.com/live2' }}"
                       style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
            </div>
            <div style="display: flex; gap: 8px;">
                <button type="submit" class="btn btn-approve" style="flex: 1;">
                    Save
                </button>
                <button type="button" class="btn btn-edit" style="flex: 1;" onclick="toggleConfig()">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Queue Stats -->
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
        <h4 style="margin-bottom: 10px; font-size: 14px;">Queue Stats</h4>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
            <div>
                <span style="color: var(--text-secondary);">Pending:</span>
                <span>{{ counts.pending if counts else 0 }}</span>
            </div>
            <div>
                <span style="color: var(--text-secondary);">Approved:</span>
                <span style="color: var(--accent-green);">{{ counts.approved if counts else 0 }}</span>
            </div>
            <div>
                <span style="color: var(--text-secondary);">Rejected:</span>
                <span>{{ counts.rejected if counts else 0 }}</span>
            </div>
            <div>
                <span style="color: var(--text-secondary);">Streamed:</span>
                <span style="color: var(--accent-blue);">{{ counts.streamed if counts else 0 }}</span>
            </div>
        </div>
    </div>

    {% if message %}
    <p style="margin-top: 10px; padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 4px; color: var(--accent-green); font-size: 13px;">
        {{ message }}
    </p>
    {% endif %}
</div>

