<div class="stream-panel">
    <h3>Stream Control</h3>

    <div class="stream-info">
        <div>
            <strong>Status:</strong>
            <span class="status-badge {{ 'approved' if stream_status.is_running else 'pending' }}">
                {{ stream_status.state if stream_status.state else 'stopped' }}
            </span>
            {% if stream_status.broadcast_mode %}
            <span class="status-badge" style="background: var(--accent-blue); margin-left: 5px;">BROADCAST</span>
            {% endif %}
        </div>
    </div>

    {% if stream_status.current_item_id or stream_status.current_item_title %}
    <div style="margin-top: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">NOW SHOWING</div>
        <div style="font-size: 13px; color: var(--accent-green);">
            {{ stream_status.current_item_title or 'Item #' + stream_status.current_item_id|string }}
        </div>
    </div>
    {% endif %}

    <div style="margin-top: 15px;">
        {% if stream_status.is_running %}
        <button class="btn btn-stream stop"
                hx-post="/api/channel/{{ channel_id }}/stream/stop"
                hx-target="#stream-status"
                hx-swap="innerHTML">
            Stop Stream
        </button>
        {% else %}
        <form hx-post="/api/channel/{{ channel_id }}/stream/start"
              hx-target="#stream-status"
              hx-swap="innerHTML"
              style="display: flex; flex-direction: column; gap: 10px;">

            <!-- Broadcast Mode Toggle -->
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                <input type="checkbox" name="broadcast_mode" value="true"
                       style="width: 18px; height: 18px; accent-color: var(--accent-green);">
                <span style="font-size: 13px;">
                    <strong style="color: var(--accent-blue);">Broadcast Mode</strong>
                    <br><span style="font-size: 11px; color: var(--text-secondary);">Animated background, scrolling ticker, transitions</span>
                </span>
            </label>

            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-stream"
                        {% if not config or not config.stream_key %}disabled title="Configure stream key first"{% endif %}>
                    Start Stream
                </button>
                <button type="button" class="btn btn-edit" onclick="togglePreview()">
                    Preview
                </button>
            </div>
        </form>
        {% endif %}
    </div>

    <!-- Stream Preview -->
    <div id="stream-preview" style="display: none; margin-top: 15px;">
        <div style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: #000;">
            <div id="frame-preview-container">
                <img id="frame-preview-img"
                     src="/api/channel/{{ channel_id }}/current-frame?t={{ range(1000000) | random }}"
                     style="width: 100%; height: auto; display: block;"
                     alt="Current Frame"
                     onerror="this.style.display='none'; document.getElementById('no-frame-msg').style.display='block';">
                <div id="no-frame-msg" style="display: none; padding: 40px; text-align: center; color: var(--text-secondary);">
                    <div style="font-size: 18px; margin-bottom: 10px;">No frames available</div>
                    <div style="font-size: 12px;">Click "Fetch Now" to get news</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stream Configuration -->
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
        <h4 style="margin-bottom: 15px; font-size: 14px; display: flex; justify-content: space-between; align-items: center;">
            Stream Configuration
            <button type="button" class="btn btn-edit" style="padding: 4px 8px; font-size: 12px;"
                    onclick="toggleConfig()">
                Edit
            </button>
        </h4>

        <!-- Config Display -->
        <div id="config-display">
            <div style="font-size: 13px; color: var(--text-secondary);">
                <div style="margin-bottom: 8px;">
                    <span>Stream Key:</span>
                    <span style="color: {{ 'var(--accent-green)' if config and config.stream_key else 'var(--accent-red)' }};">
                        {% if config and config.stream_key %}
                            ********{{ config.stream_key[-4:] }}
                        {% else %}
                            Not configured
                        {% endif %}
                    </span>
                </div>
                <div style="margin-bottom: 8px;">
                    <span>Display Time:</span>
                    <span>{{ config.display_seconds if config else 30 }}s per item</span>
                </div>
                <div>
                    <span>RTMP URL:</span>
                    <span style="font-size: 11px;">{{ config.rtmp_url if config else 'rtmp://a.rtmp.youtube.com/live2' }}</span>
                </div>
            </div>
        </div>

        <!-- Config Form (hidden by default) -->
        <form id="config-form" style="display: none;"
              hx-post="/api/channel/{{ channel_id }}/config"
              hx-target="#stream-status"
              hx-swap="innerHTML"
              hx-on::after-request="window.isEditingConfig = false">
            <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: var(--text-secondary);">
                    YouTube Stream Key
                </label>
                <input type="password"
                       name="stream_key"
                       value="{{ config.stream_key if config else '' }}"
                       placeholder="xxxx-xxxx-xxxx-xxxx"
                       style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: var(--text-secondary);">
                    Display Duration (seconds)
                </label>
                <input type="number"
                       name="display_seconds"
                       value="{{ config.display_seconds if config else 30 }}"
                       min="5"
                       max="300"
                       style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: var(--text-secondary);">
                    RTMP URL
                </label>
                <input type="text"
                       name="rtmp_url"
                       value="{{ config.rtmp_url if config else 'rtmp://a.rtmp.youtube.com/live2' }}"
                       style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
            </div>
            <div style="display: flex; gap: 8px;">
                <button type="submit" class="btn btn-approve" style="flex: 1;">
                    Save
                </button>
                <button type="button" class="btn btn-edit" style="flex: 1;" onclick="toggleConfig()">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Background Video Info (Broadcast Mode) -->
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
        <h4 style="margin-bottom: 10px; font-size: 14px;">Background Video</h4>
        <div style="font-size: 12px; color: var(--text-secondary); padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
            <p style="margin: 0 0 8px 0;">For broadcast mode, add a looping video at:</p>
            <code style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                assets/video/background.mp4
            </code>
            <p style="margin: 8px 0 0 0; font-size: 11px; color: var(--text-dim);">
                Recommended: 1920x1080, 15-30 seconds loop, no audio.
            </p>
        </div>
    </div>

    <!-- Background Music Info -->
    <div style="margin-top: 15px;">
        <h4 style="margin-bottom: 10px; font-size: 14px;">Background Music</h4>
        <div style="font-size: 12px; color: var(--text-secondary); padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
            <p style="margin: 0 0 8px 0;">To add background music, place an MP3 file at:</p>
            <code style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                assets/music/background.mp3
            </code>
            <p style="margin: 8px 0 0 0; font-size: 11px; color: var(--text-dim);">
                Music will loop continuously during the stream.
            </p>
        </div>
    </div>

    <!-- Queue Stats -->
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
        <h4 style="margin-bottom: 10px; font-size: 14px;">Queue Stats</h4>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
            <div>
                <span style="color: var(--text-secondary);">In Queue:</span>
                <span style="color: var(--accent-green);">{{ counts.approved if counts else 0 }}</span>
            </div>
            <div>
                <span style="color: var(--text-secondary);">Streamed:</span>
                <span style="color: var(--accent-blue);">{{ counts.streamed if counts else 0 }}</span>
            </div>
        </div>
    </div>

    {% if message %}
    <p style="margin-top: 10px; padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 4px; color: var(--accent-green); font-size: 13px;">
        {{ message }}
    </p>
    {% endif %}
</div>
