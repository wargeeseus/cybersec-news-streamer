{% extends "base.html" %}

{% block content %}
<div class="app-layout">
    <!-- Channel Sidebar -->
    <nav class="channel-sidebar">
        <h3>Channels</h3>
        <ul class="channel-list" id="channel-list">
            {% for channel in channels %}
            <a href="/channel/{{ channel.id }}"
               class="channel-item {% if channel.id == current_channel.id %}active{% endif %}">
                <span class="channel-status {% if channel.id == current_channel.id and stream_status.is_running %}live{% else %}offline{% endif %}"></span>
                {{ channel.name }}
            </a>
            {% endfor %}
        </ul>
        <button class="add-channel-btn" onclick="showAddChannelModal()">
            + Add Channel
        </button>
    </nav>

    <!-- Main Content -->
    <div class="main-wrapper">
        <header class="header">
            <div class="header-left">
                <span class="logo">{{ current_channel.name }}</span>
                <div class="live-badge">
                    <span class="live-dot {% if not stream_status.is_running %}offline{% endif %}"></span>
                    <span>{% if stream_status.is_running %}LIVE{% else %}OFFLINE{% endif %}</span>
                </div>
            </div>
            <div class="header-right">
                <span style="color: var(--text-secondary); font-size: 13px; margin-right: 15px;">
                    {{ current_channel.news_topic }}
                </span>
                <a href="/logout" class="btn btn-logout" style="padding: 6px 12px; font-size: 12px; background: var(--bg-tertiary); color: var(--text-secondary); text-decoration: none; border-radius: 4px;">
                    Logout
                </a>
            </div>
        </header>

        <div class="main-content">
            <div class="content-area">
                <!-- Queue Stats -->
                <div class="tabs" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div class="tab active">
                            Stream Queue <span class="count">{{ counts.approved }}</span>
                        </div>
                        <div class="tab">
                            Streamed <span class="count">{{ counts.streamed }}</span>
                        </div>
                    </div>
                    <button class="btn btn-approve"
                            hx-post="/api/channel/{{ current_channel.id }}/fetch"
                            hx-target="#news-list"
                            hx-swap="innerHTML"
                            style="white-space: nowrap;">
                        Fetch Now
                    </button>
                </div>

                {% if stream_status.current_item_title %}
                <div style="margin: 15px 0; padding: 12px; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--accent-green); border-radius: 8px;">
                    <strong style="color: var(--accent-green);">NOW STREAMING:</strong>
                    <span style="margin-left: 10px;">{{ stream_status.current_item_title }}</span>
                </div>
                {% endif %}

                <!-- News Queue List -->
                <div class="news-grid" id="news-list">
                    {% for item in queue_items %}
                    <div class="news-card {% if item.id == stream_status.current_item_id %}streaming{% endif %}">
                        <div class="news-header">
                            <span class="source">{{ item.source_name }}</span>
                            {% if item.id == stream_status.current_item_id %}
                            <span class="status-badge approved" style="font-size: 10px;">STREAMING</span>
                            {% endif %}
                        </div>
                        <h3 class="news-title">{{ item.title }}</h3>
                        <p class="news-summary">{{ item.summary }}</p>
                        <div class="news-footer">
                            <span class="time">{{ item.fetched_at.strftime('%H:%M') if item.fetched_at else '' }}</span>
                            <a href="{{ item.source_url }}" target="_blank" class="source-link">View Source</a>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <h4>No news items in queue</h4>
                        <p>Click "Fetch Now" to get news about {{ current_channel.news_topic }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <aside class="sidebar">
                <!-- Stream Control Panel -->
                <div id="stream-status"
                     hx-get="/api/channel/{{ current_channel.id }}/stream/status"
                     hx-trigger="every 5s"
                     hx-swap="innerHTML">
                    {% include "components/stream_status.html" %}
                </div>
            </aside>
        </div>
    </div>
</div>

<!-- Add Channel Modal -->
<div id="add-channel-modal" class="channel-modal">
    <div class="channel-modal-content">
        <h3>Add New Channel</h3>
        <form hx-post="/api/channel/create" hx-target="#channel-list" hx-swap="innerHTML">
            <div class="form-group">
                <label>Channel Name</label>
                <input type="text" name="name" placeholder="e.g., Tech News" required>
            </div>
            <div class="form-group">
                <label>News Topics (comma-separated keywords)</label>
                <input type="text" name="news_topic" placeholder="e.g., technology, AI, startups" required>
            </div>
            <div class="form-group">
                <label>YouTube Stream Key</label>
                <input type="text" name="stream_key" placeholder="xxxx-xxxx-xxxx-xxxx">
            </div>
            <div class="form-group">
                <label>RTMP URL</label>
                <input type="text" name="rtmp_url" value="rtmp://a.rtmp.youtube.com/live2">
            </div>
            <div class="form-group">
                <label>Display Duration (seconds)</label>
                <input type="number" name="display_seconds" value="30" min="5" max="300">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-edit" onclick="hideAddChannelModal()">Cancel</button>
                <button type="submit" class="btn btn-approve">Create Channel</button>
            </div>
        </form>
    </div>
</div>

<style>
.news-card.streaming {
    border: 2px solid var(--accent-green);
    box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
}
.header-right {
    display: flex;
    align-items: center;
}
.news-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}
.source {
    color: var(--accent-blue);
    font-size: 13px;
}
.news-footer {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 10px;
}
.source-link {
    color: var(--accent-blue);
    text-decoration: none;
}
.source-link:hover {
    text-decoration: underline;
}
</style>

<script>
function showAddChannelModal() {
    document.getElementById('add-channel-modal').classList.add('active');
}

function hideAddChannelModal() {
    document.getElementById('add-channel-modal').classList.remove('active');
}

// Close modal on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') hideAddChannelModal();
});

// Close modal on outside click
document.getElementById('add-channel-modal').addEventListener('click', function(e) {
    if (e.target === this) hideAddChannelModal();
});
</script>
{% endblock %}
